(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerpolicy&&(n.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?n.credentials="include":s.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class r{static createElement(e,{attributes:t={},classList:i=[],withNamespace:s=!0,text:n=null}={}){const o="http://www.w3.org/2000/svg",h=s?document.createElementNS(o,e):document.createElement(e);for(const d in t)h.setAttribute(d,t[d]);for(const d in i)h.classList.add(i[d]);return n&&(h.textContent=n),h}static isObject(e){return e instanceof Object&&e.constructor===Object}static isArray(e){return Array.isArray(e)}static isPrimitive(e){return e!==Object(e)}static hasPrimitiveValue(e){for(const t in e)if(r.isPrimitive(e[t]))return!0;return!1}static randomId(){const e=()=>((1+Math.random())*65536|0).toString(16).substring(1);return`${e()}${e()}-${e()}-${e()}-${e()}-${e()}${e()}${e()}`}}class u{constructor({id:e,x:t,y:i,value:s,width:n=null,height:o=null,isBaseNode:h=!1,hoverCb:d,unHoverCb:l}){this.id=e,this.hoverCb=d,this.unHoverCb=l,this.value=s,this.el=null,this.children=[],this.isBaseNode=h,this.isEmptyisEmptyBaseNodeNode=!1,this.nodeEl=null,this.foreignObjectEl=null,this.contentWrapperEl=null,this._x=t,this._y=i,this._width=n??200,this._height=o??70,this.radius=15,this._unactive=!1,this.childrenHeight=0,this.normalizedWidth=null,this.render()}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get unactive(){return this._unactive}set x(e){this._x=e,this.updateNode("x")}set y(e){this._y=e,this.updateNode("y")}set width(e){this._width=e,this.updateNode("width")}set height(e){this._height=e,this.updateNode("height")}set unactive(e){this._unactive=e,this.updateState("unactive",e)}updateNode(e){this.nodeEl.setAttribute(e,this[e]),this.foreignObjectEl.setAttribute(e,this[e])}updateState(e,t){const s={true:"add",false:"remove"}[t];this.nodeEl.classList[s](e)}adjustSize(){const{width:e,height:t}=this.contentWrapperEl.getBoundingClientRect();this.width=e,this.height=t}registListener(){this.el.addEventListener("mouseover",e=>this.hoverCb(e,this)),this.el.addEventListener("mouseleave",e=>this.unHoverCb(e,this))}prepareToRender(){this.el=r.createElement("g");const e={x:this.x,y:this.y,width:this.width,height:this.height};this.isEmptyisEmptyBaseNodeNode=!r.hasPrimitiveValue(this.value)&&this.isBaseNode,this.isEmptyisEmptyBaseNodeNode?this.nodeEl=r.createElement("circle",{classList:["node"],attributes:{cx:this.x+this.radius,cy:this.y+this.radius,r:this.radius,rx:5,ry:5}}):this.nodeEl=r.createElement("rect",{classList:["node"],attributes:{...e,rx:5,ry:5}}),this.foreignObjectEl=r.createElement("foreignObject",{classList:["node-content"],attributes:e}),this.contentWrapperEl=r.createElement("div",{classList:["node-content-wrapper"],withNamespace:!1}),this.registListener()}render(){this.prepareToRender(),this.generateContentEl(),this.el.appendChild(this.nodeEl),this.el.appendChild(this.foreignObjectEl)}generateContentEl(){r.isPrimitive(this.value)?this.generatePrimitiveContentValue():this.generateObjectContentValue(),this.foreignObjectEl.appendChild(this.contentWrapperEl)}generateObjectContentValue(){for(const e in this.value){if(typeof this.value[e]=="object")continue;const t=r.createElement("span",{withNamespace:!1,text:`${e}: ${this.value[e]}`});this.contentWrapperEl.appendChild(t)}}generatePrimitiveContentValue(){const e=r.createElement("span",{withNamespace:!1,text:this.value});this.contentWrapperEl.appendChild(e)}addChildren(e){this.children.push(e)}}const v=50,p=20,f="background",m=1.1,c=3;class y{constructor({from:e,to:t}){this.from=e,this.to=t,this.el=null,this._highlight=!1,this._unactive=!1,this.render()}get highlight(){return this._highlight}get unactive(){return this._unactive}set highlight(e){this._highlight=e,this.updateState("highlight",e)}set unactive(e){this._unactive=e,this.updateState("unactive",e)}updateState(e,t){const s={true:"add",false:"remove"}[t];this.el.classList[s](e)}render(){const e=r.createElement("g",{classList:["line"]}),t={x:this.from.x+this.from.width,y:this.from.y+this.from.height/2},i={x:this.to.x,y:this.to.y+this.to.height/2},s={x:i.x-t.x,y:i.y-t.y},n=`M${t.x} ${t.y} C${t.x+s.x} ${t.y}, ${i.x-s.x} ${i.y}, ${i.x} ${i.y}`,o=r.createElement("path",{attributes:{d:n}}),h=r.createElement("path",{classList:["arrow-head"],attributes:{d:`M${i.x-c*2} ${i.y-c} L${i.x-c*2} ${i.y+c} ${i.x} ${i.y} Z`}});e.appendChild(o),e.appendChild(h),this.el=e}}class E{constructor({container:e,data:t}){this.container=e,this.data=t,this.mouseDownHandler=this.handleMouseDown.bind(this),this.mouseMoveHandler=this.handleMouseMove.bind(this),this.mouseUpHandler=this.handleMouseUp.bind(this),this.mouseWheelHandler=this.handleMouseWheel.bind(this),this.init()}initState(){this.baseNode=null,this.lines=[],this.svg=null,this.wrapperEl=null,this.gridEl=null,this.position={x:0,y:0},this.scale=1,this.prevPosition=null,this.selectedNode=null,this.unactiveNodes=[]}init(){this.initState();const{height:e}=this.container.getBoundingClientRect();this.baseNode=new u({id:r.randomId(),hoverCb:this.handleHoverNode.bind(this),unHoverCb:this.handleUnHoverNode.bind(this),value:this.data,x:50,y:e/2,isBaseNode:!0}),this.container.replaceChildren(),this.setSVG(),this.registListener(),this.render()}setSVG(){const{width:e,height:t}=this.container.getBoundingClientRect();this.svg=r.createElement("svg",{attributes:{width:e,height:t}}),this.gridEl=r.createElement("rect",{attributes:{width:e,height:t,fill:`url(#${f})`}}),this.wrapperEl=r.createElement("g"),this.updateView(),this.svg.appendChild(this.gridPattern),this.svg.appendChild(this.gridEl),this.svg.appendChild(this.wrapperEl),this.container.appendChild(this.svg)}registListener(){this.container.addEventListener("mousedown",this.mouseDownHandler),this.container.addEventListener("mousemove",this.mouseMoveHandler),this.container.addEventListener("mouseup",this.mouseUpHandler),this.container.addEventListener("wheel",this.mouseWheelHandler)}unRegistListener(){this.container.removeEventListener("mousedown",this.mouseDownHandler),this.container.removeEventListener("mousemove",this.mouseMoveHandler),this.container.removeEventListener("mouseup",this.mouseUpHandler),this.container.removeEventListener("wheel",this.mouseWheelHandler)}get gridPattern(){const e=r.createElement("defs"),t=r.createElement("pattern",{attributes:{width:22,height:22,id:f,patternUnits:"userSpaceOnUse"}}),i=r.createElement("circle",{attributes:{cx:1.5,cy:1.5,r:1.5,fill:"#2c2b2b"}});return t.appendChild(i),e.appendChild(t),e}updateData(e){this.data=e,this.unRegistListener(),this.init()}buildTreeFromArray(e,t){for(const i of t)if(r.hasPrimitiveValue(i)){const s=this.createNode(i,e);this.buildTree(s)}else for(const s in i){const n=this.createNode(s,e);this.buildTree(n,i[s])}}buildTree(e,t=null){if(r.isObject(e.value))for(const i in e.value){if(r.isPrimitive(e.value[i]))continue;const s=this.createNode(i,e);this.buildTree(s,e.value[i])}else r.isArray(e.value)&&this.buildTreeFromArray(e,e.value);if(t!==null){if(r.isArray(t)){this.buildTreeFromArray(e,t);return}if(r.hasPrimitiveValue(t)){const i=this.createNode(t,e);this.buildTree(i)}else for(const i in t){const s=this.createNode(i,e);this.buildTree(s,t[i])}}}createNode(e,t,i=!0){const s=new u({value:e,id:r.randomId(),x:t.x+t.width,y:t.y+t.height/2,hoverCb:this.handleHoverNode.bind(this),unHoverCb:this.handleUnHoverNode.bind(this)});return i&&t.addChildren(s),s}computeTreePosition(e){const t=e??this.baseNode,i=Math.max(...t.children.map(o=>o.width)),s=p*Math.max(0,t.children.length-1);let n=0;for(const o of t.children)this.computeTreePosition(o),o.children.length===0&&(o.childrenHeight=o.height),o.normalizedWidth=i,n+=o.childrenHeight;n=Math.max(n,t.height),t.childrenHeight=n+s}updateTreePosition(e=null){const t=e??this.baseNode;for(const[i,s]of t.children.entries()){const n=t.children.filter((d,l)=>l<i).reduce((d,l)=>d+l.childrenHeight,0),o=i>0?p*i:0,h=t.normalizedWidth??t.width;s.y=t.y+n+o,s.x=t.x+h+v,this.updateTreePosition(s)}}updateView(){const{x:e,y:t}=this.position;this.wrapperEl.setAttribute("transform",`translate(${e}, ${t}) scale(${this.scale})`)}render(){this.buildTree(this.baseNode),this.renderTree(),this.computeTreePosition(),this.updateTreePosition(),this.renderLine(),console.log(this.baseNode)}renderTree(e=null){const t=e??this.baseNode;this.wrapperEl.appendChild(t.el),t.adjustSize();for(const i of t.children)this.renderTree(i)}renderLine(e=null){const t=e??this.baseNode;for(const i of t.children){this.renderLine(i);const s=new y({from:t,to:i});this.lines.push(s),this.wrapperEl.appendChild(s.el)}}buildPath(e,t){var n,o;const i=[t];let s=(n=e.find(h=>h.to.id===t.id))==null?void 0:n.from;for(;s;)i.push(s),s=(o=e.find(h=>h.to.id===s.id))==null?void 0:o.from;return i}findChildren(e){const t=[],i=[this.baseNode],s=new Set;for(;i.length;){const n=i.shift();if(!s.has(n.id)){if(s.add(n.id),n.id===e)return this.buildPath(t,n);for(const o of n.children)s.has(o.id)||(i.push(o),t.push({from:n,to:o}))}}return[]}handleHoverNode(e,t){var n;if(t.id===((n=this.selectedNode)==null?void 0:n.id))return;this.selectedNode=t;const i=this.findChildren(t.id);for(const o of i){if(o.isBaseNode)continue;const h=this.lines.find(d=>d.to.id===o.id);h.highlight=!0}const s=o=>{if(!i.find(h=>h.id===o.id)&&(o.unactive=!0,this.unactiveNodes.push(o),!o.isBaseNode)){const h=this.lines.find(d=>d.to.id===o.id);h.unactive=!0}for(const h of o.children)s(h)};s(this.baseNode)}handleUnHoverNode(e,t){for(const i of this.lines)i.highlight=!1,i.unactive=!1;for(const i of this.unactiveNodes)i.unactive=!1;this.unactiveNodes=[],this.selectedNode=null}handleMouseWheel(e){const{x:t,y:i}=this.getMousePosition(e),s={x:t-this.position.x,y:i-this.position.y},n=e.deltaY<0?m:1/m;this.position.x=t-s.x*n,this.position.y=i-s.y*n,this.scale*=n,this.updateView()}handleMouseDown(e){this.prevPosition=this.getMousePosition(e)}handleMouseMove(e){if(!this.prevPosition)return;const{x:t,y:i}=this.getMousePosition(e),s={x:t-this.prevPosition.x,y:i-this.prevPosition.y};this.position.x+=s.x,this.position.y+=s.y,this.prevPosition={x:t,y:i},this.updateView()}handleMouseUp(){this.prevPosition=null}getMousePosition(e){const{top:t,left:i}=this.container.getBoundingClientRect();return{x:e.clientX-i,y:e.clientY-t}}}const g=document.querySelector("#json"),b=document.querySelector(".json-viewer"),w=document.querySelector("#btn-render"),N=async()=>await(await fetch("./data/data.json")).json(),x=async()=>{const a=await N();g.value=JSON.stringify(a,null,2);const e=new E({container:b,data:a});w.addEventListener("click",()=>{try{const t=JSON.parse(g.value);e.updateData(t)}catch{alert("Invalid JSON")}})};window.onload=x;
